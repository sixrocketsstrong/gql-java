jdk: openjdk8
language: java
sudo: false

git:
  depth: false

services:
  - docker

install: true

branches:
  only:
  - master
  - /^v.*$/

cache:
  directories:
    - $HOME/.m2/repository

before_install:
  - git fetch --unshallow || true # Travis might do a shallow clone, but GitVersion needs the full history including branches and tags
  - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
  - git fetch origin
  - git branch master origin/master || true # GitVersion seems to require a local "master" branch these days. That's a bug, but oh well.

before_deploy:
  - FINAL_VERSION=$(docker run --rm -v `pwd`:/repo gittools/gitversion:latest-linux /repo /nocache | jq -r '.SemVer')
  - mvn versions:set -DnewVersion=$FINAL_VERSION
  - mvn package -Dmaven.test.skip=true

deploy:
  # Deploy releases to bintray
  - provider: bintray
    skip_cleanup: true        # required to prevent Travis from cleaning the workspace before deployment
    file: target/bintray.json # defines the Bintray project to deploy to, and what to deploy and where to.
    user: bangroot # fill in your account name
    key: $BINTRAY_API_KEY            # reference to your Bintray API key
    on: # only deploy when
      repo: sixrocketsstrong/gql-java # only for this repo
      tags: true
